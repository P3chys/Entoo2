name: Code Quality

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # ============================================
  # PHP Code Quality
  # ============================================
  php-quality:
    name: PHP Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: ./webapp

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo, pgsql, redis, zip, gd
          coverage: none
          tools: composer

      - name: Create cache directory
        run: mkdir -p bootstrap/cache

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Run Laravel Pint
        id: pint
        run: ./vendor/bin/pint --test
        continue-on-error: true

      - name: Run PHPStan
        id: phpstan
        run: |
          ./vendor/bin/phpstan analyse --memory-limit=2G --error-format=json > phpstan-report.json || true
          errors=$(jq -r '.totals.errors // 0' phpstan-report.json)
          echo "errors=$errors" >> $GITHUB_OUTPUT
          if [ "$errors" -gt 0 ]; then
            echo "::warning::Found $errors PHPStan errors"
          fi
        continue-on-error: true

      - name: Run PHP Code Sniffer
        id: phpcs
        run: |
          ./vendor/bin/phpcs --standard=PSR12 app/ --report=json > phpcs-report.json || true
          if [ -f phpcs-report.json ]; then
            totalIssues=$(jq -r '.totals.errors + .totals.warnings' phpcs-report.json)
            echo "Found $totalIssues PHPCS issues"
            echo "issues=$totalIssues" >> $GITHUB_OUTPUT
          else
            echo "issues=0" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check for code smells
        id: code_smells
        run: |
          echo "Checking for common code smells..."

          # Check for TODO/FIXME comments
          if grep -rn "TODO\|FIXME\|XXX\|HACK" app/ 2>/dev/null; then
            echo "::warning::Found TODO/FIXME comments that should be addressed"
          fi

          # Check for var_dump/dd/dump usage
          if grep -rn "var_dump\|\bdd(\|\bdump(" app/ 2>/dev/null; then
            echo "::error::Found debug statements in code!"
            exit 1
          fi

          # Check for long files (>500 lines)
          find app/ -name "*.php" -exec wc -l {} \; | while read lines file; do
            if [ "$lines" -gt 500 ]; then
              echo "::warning::File $file has $lines lines - consider refactoring"
            fi
          done
        continue-on-error: true

      - name: Measure code complexity
        id: complexity
        run: ./vendor/bin/phpstan analyse --level=max app/ --no-progress --error-format=json > complexity.json || true
        continue-on-error: true

      - name: Generate PHP quality report
        if: always()
        run: |
          echo "## PHP Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status | Issues |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Laravel Pint | ${{ steps.pint.outcome }} | N/A |" >> $GITHUB_STEP_SUMMARY
          echo "| PHPStan | ${{ steps.phpstan.outcome }} | ${{ steps.phpstan.outputs.errors }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PHPCS (PSR12) | ${{ steps.phpcs.outcome }} | ${{ steps.phpcs.outputs.issues }} |" >> $GITHUB_STEP_SUMMARY

      - name: Upload quality reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: php-quality-reports
          path: |
            phpstan-report.json
            phpcs-report.json
            complexity.json
          retention-days: 30

  # ============================================
  # JavaScript Code Quality
  # ============================================
  js-quality:
    name: JavaScript Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: ./webapp

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './webapp/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        id: eslint
        run: |
          npx eslint resources/js/**/*.js --format json --output-file eslint-report.json || true
          if [ -f eslint-report.json ]; then
            totalIssues=$(jq '[.[].errorCount] | add' eslint-report.json)
            totalWarnings=$(jq '[.[].warningCount] | add' eslint-report.json)
            total=$((totalIssues + totalWarnings))
            echo "Found $total ESLint issues"
            echo "issues=$total" >> $GITHUB_OUTPUT
          else
            echo "issues=0" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check for console statements
        id: console_check
        run: |
          count=$(grep -r "console\.\(log\|debug\|info\|warn\|error\)" resources/js/ 2>/dev/null | wc -l || echo "0")
          if [ "$count" -gt 0 ]; then
            echo "::warning::Found $count console statements"
          fi
          echo "count=$count" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Check bundle size
        id: bundle_size
        run: |
          npm run build

          # Check build output size
          buildSizeBytes=$(du -sb public/build 2>/dev/null | cut -f1 || echo "0")
          buildSizeMB=$(echo "scale=2; $buildSizeBytes / 1048576" | bc)
          echo "Total build size: $buildSizeMB MB"

          if [ $(echo "$buildSizeMB > 5" | bc) -eq 1 ]; then
            echo "::warning::Build size exceeds 5MB threshold"
          fi

          echo "size_mb=$buildSizeMB" >> $GITHUB_OUTPUT

      - name: Analyze JavaScript complexity
        id: js_complexity
        run: |
          # Check for large files (>10KB)
          largeFiles=$(find resources/js -name "*.js" -size +10k 2>/dev/null || true)
          if [ -n "$largeFiles" ]; then
            echo "::warning::Found JavaScript files >10KB:"
            echo "$largeFiles"
          fi
        continue-on-error: true

      - name: Generate JavaScript quality report
        if: always()
        run: |
          echo "## JavaScript Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint Issues | ${{ steps.eslint.outputs.issues }} | ${{ steps.eslint.outputs.issues == 0 && '✅' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Console Statements | ${{ steps.console_check.outputs.count }} | ${{ steps.console_check.outputs.count == 0 && '✅' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bundle Size | ${{ steps.bundle_size.outputs.size_mb }} MB | ${{ steps.bundle_size.outputs.size_mb < 5 && '✅' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Upload JavaScript quality reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: js-quality-reports
          path: webapp/eslint-report.json
          retention-days: 30

  # ============================================
  # Documentation Quality
  # ============================================
  docs-quality:
    name: Documentation Quality
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ ! -f README.md ]; then
            echo "⚠️ README.md not found"
            exit 1
          fi

      - name: Check for broken links in markdown
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
        continue-on-error: true

      - name: Spell check documentation
        uses: rojopolis/spellcheck-github-actions@0.35.0
        with:
          config_path: .github/spellcheck-config.yml
        continue-on-error: true

      - name: Check API documentation is up to date
        run: |
          if [ -f webapp/storage/api-docs/api-docs.json ]; then
            echo "✅ API documentation found"
            # Check if it's recent (modified in last 30 days)
            LAST_MODIFIED=$(stat -c %Y webapp/storage/api-docs/api-docs.json)
            CURRENT_TIME=$(date +%s)
            DIFF=$(( (CURRENT_TIME - LAST_MODIFIED) / 86400 ))

            if [ $DIFF -gt 30 ]; then
              echo "⚠️ API documentation is $DIFF days old - consider regenerating"
            fi
          else
            echo "⚠️ API documentation not found - run: php artisan l5-swagger:generate"
          fi

  # ============================================
  # Overall Quality Score
  # ============================================
  quality-score:
    name: Calculate Quality Score
    runs-on: ubuntu-latest
    needs: [php-quality, js-quality, docs-quality]
    if: always()

    steps:
      - name: Calculate quality score
        run: |
          echo "## Overall Code Quality Score" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Calculate score based on job results
          SCORE=100

          if [ "${{ needs.php-quality.result }}" != "success" ]; then
            SCORE=$((SCORE - 30))
          fi

          if [ "${{ needs.js-quality.result }}" != "success" ]; then
            SCORE=$((SCORE - 30))
          fi

          if [ "${{ needs.docs-quality.result }}" != "success" ]; then
            SCORE=$((SCORE - 10))
          fi

          echo "**Quality Score: $SCORE/100**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $SCORE -lt 70 ]; then
            echo "❌ Quality score below acceptable threshold (70)" >> $GITHUB_STEP_SUMMARY
            echo "Please address the issues identified in the quality checks." >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ $SCORE -lt 90 ]; then
            echo "⚠️ Quality score acceptable but could be improved" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ Excellent code quality!" >> $GITHUB_STEP_SUMMARY
          fi
